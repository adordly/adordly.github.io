<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>基于SpringSecurity的认证授权 | 咳咳</title><meta name="keywords" content="SpringSecurity"><meta name="author" content="咳咳"><meta name="copyright" content="咳咳"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="基于SpringSecurity的认证授权 之前学习boot时，粗略的学习了一下Shiro和SpringSecurity，只是会基本的使用，但说到原理，不是很了解，今天刚好给课设添加登录认证授权，系统的学习了一下SpringSecurity的底层原理和定制化配置，确实也是基本掌握了，在此记一笔，方便以后回顾.  说到SpringSeCurity,相信大家都不陌生，说的高大上，是一个跟Springb"><meta property="og:type" content="article"><meta property="og:title" content="基于SpringSecurity的认证授权"><meta property="og:url" content="https://jhuarui.work/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/index.html"><meta property="og:site_name" content="咳咳"><meta property="og:description" content="基于SpringSecurity的认证授权 之前学习boot时，粗略的学习了一下Shiro和SpringSecurity，只是会基本的使用，但说到原理，不是很了解，今天刚好给课设添加登录认证授权，系统的学习了一下SpringSecurity的底层原理和定制化配置，确实也是基本掌握了，在此记一笔，方便以后回顾.  说到SpringSeCurity,相信大家都不陌生，说的高大上，是一个跟Springb"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://jhuarui.work/img/springboot/security.jpeg"><meta property="article:published_time" content="2022-05-15T15:23:47.000Z"><meta property="article:modified_time" content="2022-06-22T14:45:10.568Z"><meta property="article:author" content="咳咳"><meta property="article:tag" content="SpringSecurity"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://jhuarui.work/img/springboot/security.jpeg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://jhuarui.work/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"基于SpringSecurity的认证授权",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-06-22 22:45:10"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0!==o){const a=new Date;o=864e5*o,t={value:t,expiry:a.getTime()+o};localStorage.setItem(e,JSON.stringify(t))}},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);const o=new Date;if(!(o.getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=a=>new Promise((t,e)=>{const o=document.createElement("script");o.src=a,o.async=!0,o.onerror=e,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/social_img.jpeg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/springboot/security.jpeg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">咳咳</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于SpringSecurity的认证授权</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-15T15:23:47.000Z" title="发表于 2022-05-15 23:23:47">2022-05-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-22T14:45:10.568Z" title="更新于 2022-06-22 22:45:10">2022-06-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringSecurity/">SpringSecurity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="基于SpringSecurity的认证授权"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基于SpringSecurity的认证授权"><a href="#基于SpringSecurity的认证授权" class="headerlink" title="基于SpringSecurity的认证授权"></a>基于SpringSecurity的认证授权</h1><blockquote><p>之前学习boot时，粗略的学习了一下<code>Shiro</code>和<code>SpringSecurity</code>，只是会基本的使用，但说到原理，不是很了解，今天刚好给课设添加登录认证授权，系统的学习了一下<code>SpringSecurity</code>的底层原理和定制化配置，确实也是基本掌握了，在此记一笔，方便以后回顾.</p></blockquote><p>说到<code>SpringSeCurity</code>,相信大家都不陌生，说的高大上，是一个跟<code>Springboot</code>良好集成的<strong>安全框架</strong>，说的易懂一点，其实就是一条<strong>过滤器链</strong>，向我们不用<code>SpringSeCurity</code>的时候，要实现登录认证授权，就需要自己手写过滤器和拦截器了，确实有点麻烦，那么使用<code>SpringSecurity</code>确实方便很多，下面来看看传统认证流程和<code>SpringSecurity</code>的认证流程有些啥区别：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142147838.png" alt="image-20220514214713055"></p><p>可以看到，加了框架，在到达Controller之前，需要经过一条过滤器链，这条过滤器链，就是咱们安全的保障，能够最后经过这条链路的，都是”勇士”，传统的认证，咱们可以到达Controller，Controller调用Service层，去数据库通过用户名查询用户全部的信息，然后将用户的密码和请求体中的密码进行比较：</p><ul><li>若不一致，就返回”用户名或密码错误”的信息.</li><li>若一致， 就将用户存入session返回sessionId，或者基于userId生成token令牌返回给前端，后序持久到redis中，代表用户登录了。</li></ul><p><em><strong>这么一听，确实，也可以实现，但为什么还要使用SpringSecurity呢对吧？</strong></em></p><p><strong>框架</strong>，就强在它的完整性，它提供了一整套完整的认证授权流程，我们只需要在这个流程基础上，添加上少许自定义配置就可以实现严格的认证授权功能。</p><p><em><strong>说了这么多，下面正式进入正题了，咱们就是要用<code>SpringSecurity</code>实现认证授权，那么认证和授权到底是什么呢？</strong></em></p><ul><li><strong>认证：</strong>就是确定到底你是哪个用户，也就是登录的作用，登录就是为了确定你所扮演的角色。</li><li><strong>授权</strong>：确定了你是哪个用户后，那么就需要不同角色授予不同的权限，比如：管理员（登录认证为是管理员）具有管理后台的权限，而普通用户就没用该权限。</li></ul><p>做了那么多铺垫，下面就正式来揭开SpringSecurity的真面目：</p><h2 id="工作流程："><a href="#工作流程：" class="headerlink" title="工作流程："></a>工作流程：</h2><blockquote><p>就是在到达<code>Controller</code>之前的一条<strong>过滤器链</strong>，其中完成了用户<strong>认证和授权</strong>。</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142203197.png" alt="image-20220514220329142"></p><ul><li>**<code>UsernamePasswordAuthenticationFilter</code> **：负责处理我们登录页填写了用户名密码后的登录请求。</li><li>**<code>ExceptionTranslationFilter</code>**：处理过滤器中抛出的任何<code>AccessDeniedException</code>（权限异常）和<code>AuthenticationException</code>（认证异常）。</li><li>**<code>FilterSecurityInterceptor</code>**：负责权限校验的过滤器。</li></ul><p>其他的过滤器就不过多的说明了，主要我们使用需要接触到这三个过滤器。</p><h2 id="FilterChainProxy"><a href="#FilterChainProxy" class="headerlink" title="FilterChainProxy"></a>FilterChainProxy</h2><p>SpringSecurity添加了一个FilterChainProxy，这个代理过滤器会创建一套自定义的过滤器链，然后执行这一套过滤器链，也就是生成了上面图中的一整条过滤链路，我们来大致看看源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">                     FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    ...省略其他代码</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取Spring Security的一套过滤器</span></span><br><span class="line">    List&lt;Filter&gt; filters = getFilters(request);</span><br><span class="line">    <span class="comment">// 将这一套过滤器组成Spring Security自己的过滤链，并开始执行</span></span><br><span class="line">    <span class="type">VirtualFilterChain</span> <span class="variable">vfc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VirtualFilterChain</span>(fwRequest, chain, filters);</span><br><span class="line">    vfc.doFilter(request, response);</span><br><span class="line">    </span><br><span class="line">    ...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dubug看看到底SpringSecurity启动了多少条过滤器：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142213181.png" alt="image-20220514221306105"></p><p>看的让人头皮发麻，不要怕，让我们继续往下学！全部的精髓都在这一条的过滤器中，掌握了这条过滤器链和其中调用了的一些组件，等于你也就掌握了SpringSecurity。</p><h2 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h2><blockquote><p>只需要导入SpringSecurity的启动器就行。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>导入该依赖后，你再启动程序，会发现啥接口都访问不了了，因为被SpringSecurity保护了，没用自定义配置之前，啥接口都会被拦截掉，相反的会跳转到一个login页面，你需要提供<strong>账号</strong>（默认为user）和<strong>密码</strong>（启动项目时控制台会输出一串字符），登陆后才能访问到相应接口。</p><p>实际开发中，显然默认配置是不满足我们的需求的，我们就需要自定义一些配置。</p><h2 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h2><blockquote><p>很简单，只需要添加一个配置类.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="comment">//标记该注解，会注入ioc容器，并指定该类为SpringSecurity配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;&#125;</span><br><span class="line"><span class="comment">//该类需要继承WebSecurityConfigurerAdapter，重写其中的一些方法来自定义</span></span><br></pre></td></tr></table></figure><h3 id="登录认证"><a href="#登录认证" class="headerlink" title="登录认证"></a>登录认证</h3><blockquote><p>不管运用什么框架完成登录认证，思想是不变的。</p></blockquote><p>如何判断当前是哪个用户正在使用咱们的系统就是登录认证的<strong>最终目的</strong>。如果不知道是哪个用户，A下了订单，结果要B来付钱，岂不是很尴尬。判断当前的用户在**<code>SpringSecurity</code><strong>的实现就是</strong><code>Authentication</code>**，它其实就是用户的一种封装，其中包含用户信息和权限信息。</p><p>在我们的程序中，需要通过**<code>SecurityContext</code><strong>类（上下文对象）来获取到当前的</strong><code>Authentication</code>**。</p><blockquote><p>这种在一个线程中，横跨若干个方法，但每个方法中都需要使用和传递的对象，就称为<strong>上下文（context）</strong>，上下文对象很有必要，要不你需要每个方法都加一个参数来提供这个对象。</p></blockquote><p>而这个上下文对象交给**<code>SecurityContextHolder</code>**来管理，可以通过它来获得上下文对象，进而获得咱们的用户认证信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br></pre></td></tr></table></figure><p><strong>调用链路：SecurityContextHolder—&gt;SecurityContext—&gt;Authentication</strong></p><h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><p>📝<code>Authentication</code>：存储了认证信息，代表当前登录用户</p><p>📝<code>SeucirtyContext</code>：上下文对象，用来获取<code>Authentication</code></p><p>📝<code>SecurityContextHolder</code>：上下文管理对象，用来在程序任何地方获取<code>SecurityContext</code>（类似于ThreadLocal）</p><p>他们仨的关系是这样的：<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142233669.png" alt="image-20220514223327577"></p><h4 id="认证逻辑"><a href="#认证逻辑" class="headerlink" title="认证逻辑"></a>认证逻辑</h4><p>之前没用框架的逻辑是这样的：查询用户数据–&gt;判断是否正确–&gt;正确就将用户信息储存在上下文中表示用户登录了.</p><p>用了框架也一样，只不过是将用户（Authentication）放入上下文（SeucirtyContext）就能完成认证了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(用户名，用户密码，用户的权限集合);</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></pre></td></tr></table></figure><p>这时认证完成后，后面的过滤器链都可以通过获得这个<strong>authentication</strong>来进行针对性的操作，比如授权等，所以认证过滤器通常是放在过滤器第一位的，要不后面过滤器连**<code>authentication</code>**也就是用户都不知道，拿屁操作。</p><p>那么，我们需要判断这个登录用户是否合法后才能放入上下文，就需要有一个判断流程，这个流程跟不加框架是一样的，都是可以操作调用Service层处理，就像这样：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginParam param)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(userService.login(账号,密码))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;账号或密码错误&quot;</span>;</span><br><span class="line">        &#125;       </span><br><span class="line">        <span class="comment">// 生成一个包含账号密码的认证信息</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(param.getUsername(), param.getPassword());</span><br><span class="line">        <span class="comment">// 将返回的Authentication存到上下文中</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>等于说Service完成了所有判断，但SpringSecurity中也有相应的<strong>判断组件</strong>供我们使用，更加方便。</p><p>如果我们不做操作，会经过**<code>UsernamePasswordAuthenticationFilter</code>**来判断用户名和密码，但是如果是调用它的，就跟刚开始说的，是判断框架自带的账号密码，并不是我们数据库查出来的，没啥用，我们可以参考一下这个过滤器中的源码写法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainUsername(request);</span><br><span class="line">        username = username != <span class="literal">null</span> ? username : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        username = username.trim();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainPassword(request);</span><br><span class="line">        password = password != <span class="literal">null</span> ? password : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">        <span class="built_in">this</span>.setDetails(request, authRequest);</span><br><span class="line">        <span class="comment">//这个是关键：调用了AuthenticationManager其中的authenticate方法完成判断</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以，咱们自己写，也可以来通过AuthenticationManager其中的authenticate方法来完成判断。</p><h4 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h4><p>要使用AuthenticationManager，我们先在ioc中添加AuthenticationManager组件.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll() <span class="comment">//表示所有人可以访问</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>注意：我们需要对登录接口”&#x2F;login”放行才行，要不就会经过”残酷”的过滤器链，包括<code>UsernamePasswordAuthenticationFilter</code>，那么自定义登录认证也就失去意义了哦！！</strong></p><p>接口定义：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginParam param)</span> &#123;</span><br><span class="line">        <span class="comment">// 生成一个包含账号密码的认证信息</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(param.getUsername(), param.getPassword());</span><br><span class="line">        <span class="comment">// AuthenticationManager校验这个认证信息，返回一个已认证的Authentication</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> authenticationManager.authenticate(authentication);</span><br><span class="line">        <span class="comment">// 将返回的Authentication存到上下文中</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是不是思路清晰了很多，**<code>AuthenticationManager</code><strong>完成了之前</strong><code>userService</code>**的业务操作。</p><h5 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h5><p>根据<strong>用户名</strong>先查询出<strong>用户对象</strong>(没有查到则抛出异常)👉将用户对象的密码和传递过来的密码进行校验，密码不匹配则抛出异常</p><p>这个逻辑没啥好说的，再简单不过了。<strong>重点是这里每一个步骤Spring Security都提供了组件</strong>：</p><p>📝是谁执行 <strong>根据用户名查询出用户对象</strong> 逻辑的呢？用户对象数据可以存在内存中、文件中、数据库中，你得确定好怎么查才行。这一部分就是交由<strong>💡<code>UserDetialsService</code></strong> 处理，该接口只有一个方法<code>loadUserByUsername(String username)</code>，通过用户名查询用户对象，默认实现是在内存中查询。</p><p>📝那查询出来的 <strong>用户对象</strong> 又是什么呢？每个系统中的用户对象数据都不尽相同，咱们需要确认我们的用户数据是啥样的才行。Spring Security中的用户数据则是由<strong>💡<code>UserDetails</code></strong> 来体现，该接口中提供了账号、密码等通用属性。</p><p>📝<strong>对密码进行校验</strong>大家可能会觉得比较简单，<code>if、else</code>搞定，就没必要用什么组件了吧？但框架毕竟是框架考虑的比较周全，除了<code>if、else</code>外还解决了密码加密的问题，这个组件就是**💡<code>PasswordEncoder</code>**，负责密码加密与校验。</p><p>我们可以看下<code>AuthenticationManager</code>校验逻辑的大概源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    ...省略其他代码</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 传递过来的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">    <span class="comment">// 调用UserDetailService的方法，通过用户名查询出用户对象UserDetail（查询不出来UserDetailService则会抛出异常）</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">    <span class="type">String</span> <span class="variable">presentedPassword</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 传递过来的密码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line">    <span class="comment">// 使用密码解析器PasswordEncoder传递过来的密码是否和真实的用户密码匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!passwordEncoder.matches(password, userDetails.getPassword())) &#123;</span><br><span class="line">        <span class="comment">// 密码错误则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;错误信息...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注意哦，这里返回的已认证Authentication，是将整个UserDetails放进去充当Principal</span></span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails,</span><br><span class="line">				authentication.getCredentials(), userDetails.getAuthorities());</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">    </span><br><span class="line">    ...省略其他代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>流程：UserDetialsService--&gt;UserDetails---&gt;PasswordEncoder。</code></strong></p><h6 id="UserDetials"><a href="#UserDetials" class="headerlink" title="UserDetials"></a>UserDetials</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="comment">//权限等级</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> level;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="comment">//用户信息</span></span><br><span class="line">    <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">    <span class="comment">//权限集合</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; permission;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginUser</span><span class="params">(UserInfo userInfo,List&lt;String&gt; permission)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userInfo = userInfo;</span><br><span class="line">        <span class="built_in">this</span>.permission = permission;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String s : <span class="built_in">this</span>.permission) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(s));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.userInfo.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.userInfo.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="UserDetialsService"><a href="#UserDetialsService" class="headerlink" title="UserDetialsService"></a>UserDetialsService</h6><blockquote><p>业务实现这个接口，重写其中的<code>loadUserByUsername</code>方法即可。这个方法就执行根据用户名到数据库中查找相应用户，并封装成UserDetails类返回的操作.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>, UserDetailsService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名 查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserInfo <span class="title function_">findUserByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(username)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;请输入用户名!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LambdaQueryWrapper&lt;UserInfo&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(UserInfo::getUsername, username);</span><br><span class="line">        wrapper.last(<span class="string">&quot;limit 1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(userInfo)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户们不存在!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写UserDetailService的方法来自定义</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.findUserByUsername(s);</span><br><span class="line">        <span class="keyword">if</span>(user.getLevel() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//1:管理员，具有&quot;user&quot;, &quot;admin&quot;权限。</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;admin&quot;</span>)));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//2：用户</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;user&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h6><blockquote><p>可以看到**<code>authenticate</code>**方法中使用了密码加密校验，但是框架自带的是{noop}明文校验，明文校验并不安全，所以我们可以配置一下自己的校验器。在开始的配置文件中添加一个加密器到容器中即可。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><blockquote><p>说完了认证，授权其实就简单了，只是在**<code>Authentication</code>**类中多添加一个用户的权限集合就行了.也可以通过注解实现，但我并不推荐，注解在后序的维护中及其困难。</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142348682.png" alt="image-20220514234823604"></p><p>最主要的是，这些权限有啥用，肯定是不同权限能够访问不同的资源撒，那么我们需要在配置类中配置对应的权限能够访问哪些接口，接口就是对应的资源了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()    <span class="comment">//关闭csrf防止跨域攻击</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)  <span class="comment">//不通过Session获取SecurityContext</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/error&quot;</span>,<span class="string">&quot;/auth&quot;</span>, <span class="string">&quot;/comment/getAll&quot;</span>, <span class="string">&quot;/foodCategory/**&quot;</span>, <span class="string">&quot;/foodMaterial/**&quot;</span>, <span class="string">&quot;/introduce/**&quot;</span>, <span class="string">&quot;/mainPage/**&quot;</span>).permitAll() <span class="comment">//表示所有人都可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/end/**&quot;</span>).hasAuthority(<span class="string">&quot;admin&quot;</span>)  <span class="comment">//表示只有具有&quot;admin&quot;权限才能访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/comment/&quot;</span>, <span class="string">&quot;/foodCollect&quot;</span>, <span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;/update&quot;</span>).authenticated() <span class="comment">//表示需要登录认证才能访问</span></span><br><span class="line">                .and()</span><br><span class="line">                .cors();   <span class="comment">//允许跨域</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="异常自定义处理"><a href="#异常自定义处理" class="headerlink" title="异常自定义处理"></a>异常自定义处理</h3><blockquote><p>如果你自己实战过，可以发现，添加了框架后，认证授权会报很多你之前没有见过的异常，这些是SpringSecurity自定义的异常，由其中的一个过滤器**<code>ExceptionTranslationFilter</code>**处理。</p></blockquote><p>如果我们不自定义异常处理，那么返回给用户的消息就是这样的：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205142335222.png" alt="image-20220514233519173"></p><p>这违背了我们统一消息体返回的原则，那么我们需要自定义配置异常处理:</p><p>异常分为认证异常，授权异常，有相应的处理器:</p><p><strong>AuthenticationEntryPoint</strong></p><blockquote><p>认证异常处理器,是一个接口，咱们自定义认证异常处理需要实现这个接口。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        httpServletResponse.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        httpServletResponse.getWriter().print(JSONUtil.toJsonStr(Result.fail(ResultCode.NOT_ACCESS.getCode(), ResultCode.NOT_ACCESS.getMsg())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AccessDeniedHandler</strong></p><blockquote><p>授权认证处理器,也是一个接口，自定义授权异常处理需要实现这个接口。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthorizationHandler</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        httpServletResponse.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        httpServletResponse.getWriter().print(JSONUtil.toJsonStr(Result.fail(ResultCode.NOT_AUTH.getCode(), ResultCode.NOT_AUTH.getMsg())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：<code>ResultCode</code>是自定义的返回类哈，需要自己写emmm</strong></p><p>编写了自己的配置，还需要添加到SpringSecurity的配置中去:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyAuthenticationEntryPoint myAuthenticationEntryPoint;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyAuthorizationHandler myAuthorizationHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authenticationEntryPoint(myAuthenticationEntryPoint)</span><br><span class="line">             .accessDeniedHandler(myAuthorizationHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么之后出现了认证或者授权异常，都会进入我们的异常处理类中进行相应处理.</p><h3 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h3><blockquote><p>前后端分离，通常使用JWT来认证，那么用户登录后，返回的token，之后的请求都需要在请求头中添加token，以便于后端验证。</p></blockquote><p><em>那么问题是，之前咱们的过滤器都是针对登录认证的，没有应对登录后用户请求的过滤器，无法处理请求中的token，若不处理，进入到<code>UsernamePasswordAuthenticationFilter</code>，又会使用框架自带的账号密码来过滤，就很尴尬，那么怎么办呢？</em></p><p>自定义一个过滤器不就行了嘛,用来专门验证请求的token，如果token合法，就生成**<code>Authentication</code><strong>存入上下文对象中，这样，后面的过滤器调用上下文中的</strong><code>Authentication</code>**，就会知道该用户已经认证过了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">//放行，后面会报错</span></span><br><span class="line">            filterChain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userService.findUserByToken(token);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(userInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//放行，后面会报错</span></span><br><span class="line">            filterChain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//配置到上下文中</span></span><br><span class="line">        <span class="comment">//授权</span></span><br><span class="line">        LoginUser loginUser;</span><br><span class="line">        Authentication authentication;</span><br><span class="line">        <span class="keyword">if</span>(userInfo.getLevel() == <span class="number">1</span>) &#123;</span><br><span class="line">            loginUser = <span class="keyword">new</span> <span class="title class_">LoginUser</span>(userInfo,<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;admin&quot;</span>)));</span><br><span class="line">            authentication = <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">            System.out.println(loginUser.getAuthorities());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            loginUser = <span class="keyword">new</span> <span class="title class_">LoginUser</span>(userInfo,<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;user&quot;</span>)));</span><br><span class="line">            authentication = <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将这个过滤器配置到过滤器链中去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JWTAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>放在**<code>UsernamePasswordAuthenticationFilter</code><strong>过滤之前，替代了默认的认证过滤器。登陆后的用户访问其他接口时，就会带上</strong>token**进入到我们自定义的认证过滤器中验证了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://jhblog-image.oss-cn-chengdu.aliyuncs.com/blogImg/202205150023834.png" alt="image-20220515002354734"></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">咳咳</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jhuarui.work/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/">https://jhuarui.work/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">此文章版权归咳咳所有，如有转载，请註明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringSecurity/">SpringSecurity</a></div><div class="post_share"><div class="social-share" data-image="/img/springboot/security.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/16/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fbs.jpg" onerror='onerror=null,src="/img/404.jpeg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">分布式缓存与分布式锁</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/09/ElasticSearch/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Es/es.jpeg" onerror='onerror=null,src="/img/404.jpeg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ES基础用法</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/03/13/SpringSecurity/" title="SpringSecurity笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Spring/SpringSecurity.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-13</div><div class="title">SpringSecurity笔记</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/social_img.jpeg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">咳咳</div><div class="author-info__description">没有选择会是唯一的路</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://adordly.github.io/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">一名拖更的懒博主</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83"><span class="toc-number">1.</span> <span class="toc-text">基于SpringSecurity的认证授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">工作流程：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FilterChainProxy"><span class="toc-number">1.2.</span> <span class="toc-text">FilterChainProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">依赖配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">自定义配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">登录认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">核心组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E9%80%BB%E8%BE%91"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">认证逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AuthenticationManager"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">AuthenticationManager</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">1.4.1.3.1.</span> <span class="toc-text">原理：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#UserDetials"><span class="toc-number">1.4.1.3.1.1.</span> <span class="toc-text">UserDetials</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UserDetialsService"><span class="toc-number">1.4.1.3.1.2.</span> <span class="toc-text">UserDetialsService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#PasswordEncoder"><span class="toc-number">1.4.1.3.1.3.</span> <span class="toc-text">PasswordEncoder</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">1.4.2.</span> <span class="toc-text">授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86"><span class="toc-number">1.4.3.</span> <span class="toc-text">异常自定义处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">自定义过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/06/26/RabbitMQ/" title="RabbitMQ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/RabbitMQ/RabbitMQ.jpeg" onerror='this.onerror=null,this.src="/img/404.jpeg"' alt="RabbitMQ"></a><div class="content"><a class="title" href="/2022/06/26/RabbitMQ/" title="RabbitMQ">RabbitMQ</a><time datetime="2022-06-25T17:23:47.000Z" title="发表于 2022-06-26 01:23:47">2022-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/16/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" title="分布式缓存与分布式锁"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/fbs.jpg" onerror='this.onerror=null,this.src="/img/404.jpeg"' alt="分布式缓存与分布式锁"></a><div class="content"><a class="title" href="/2022/05/16/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" title="分布式缓存与分布式锁">分布式缓存与分布式锁</a><time datetime="2022-05-16T07:23:47.000Z" title="发表于 2022-05-16 15:23:47">2022-05-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/" title="基于SpringSecurity的认证授权"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/springboot/security.jpeg" onerror='this.onerror=null,this.src="/img/404.jpeg"' alt="基于SpringSecurity的认证授权"></a><div class="content"><a class="title" href="/2022/05/15/%E5%9F%BA%E4%BA%8ESpringSecurity%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/" title="基于SpringSecurity的认证授权">基于SpringSecurity的认证授权</a><time datetime="2022-05-15T15:23:47.000Z" title="发表于 2022-05-15 23:23:47">2022-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/09/ElasticSearch/" title="ES基础用法"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Es/es.jpeg" onerror='this.onerror=null,this.src="/img/404.jpeg"' alt="ES基础用法"></a><div class="content"><a class="title" href="/2022/05/09/ElasticSearch/" title="ES基础用法">ES基础用法</a><time datetime="2022-05-09T14:23:47.000Z" title="发表于 2022-05-09 22:23:47">2022-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/02/JSR303%E6%A0%A1%E9%AA%8C/" title="JSR303数据校验"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Spring/JSR303.jpeg" onerror='this.onerror=null,this.src="/img/404.jpeg"' alt="JSR303数据校验"></a><div class="content"><a class="title" href="/2022/05/02/JSR303%E6%A0%A1%E9%AA%8C/" title="JSR303数据校验">JSR303数据校验</a><time datetime="2022-05-01T17:23:47.000Z" title="发表于 2022-05-02 01:23:47">2022-05-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/springboot/security.jpeg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 咳咳</div><div class="footer_custom_text">Hi, welcome to my blog</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"GsGNLORFmjCB9yFfADJIBAR4-gzGzoHsz",appKey:"DeLHVpVyM3s1NHtFDhAuQeMY",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(n)}function loadOtherComment(){loadValine()}btf.loadComment(document.getElementById("vcomment"),loadValine)</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>